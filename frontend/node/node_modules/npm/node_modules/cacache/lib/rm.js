'use strict'

const { rm } = require('fs/promises')
const glob = require('cacache/lib/util/glob.js')
const index = require('cacache/lib/entry-index')
const memo = require('cacache/lib/memoization')
const path = require('path')
const rmContent = require('cacache/lib/content/rm')

module.exports = entry
module.exports.entry = entry

function entry (cache, key, opts) {
  memo.clearMemoized()
  return index.delete(cache, key, opts)
}

module.exports.content = content

function content (cache, integrity) {
  memo.clearMemoized()
  return rmContent(cache, integrity)
}

module.exports.all = all

async function all (cache) {
  memo.clearMemoized()
  const paths = await glob(path.join(cache, '*(content-*|index-*)'), { silent: true, nosort: true })
  return Promise.all(paths.map((p) => rm(p, { recursive: true, force: true })))
}
